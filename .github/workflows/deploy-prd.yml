name: Deploy to Production (Multi-Server)

on:
  workflow_run:
    workflows: ["Docker Release"]
    types: [completed]
    branches: [PRD]
  workflow_dispatch:

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  prepare:
    name: Load server registry
    # Skip if Docker Release failed/cancelled (workflow_dispatch always runs)
    if: github.event_name == 'workflow_dispatch' || github.event.workflow_run.conclusion == 'success'
    runs-on: ubuntu-latest
    outputs:
      servers: ${{ steps.load-servers.outputs.servers }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: PRD

      - name: Load server registry
        id: load-servers
        run: |
          # Load servers from JSON and convert to GitHub Actions matrix format
          SERVERS=$(jq -c '.servers' .github/servers/production.json)
          echo "servers=$SERVERS" >> $GITHUB_OUTPUT

          # Print server count for visibility
          COUNT=$(echo "$SERVERS" | jq 'length')
          echo "üì° Found $COUNT production servers to deploy"

  deploy:
    name: Deploy to ${{ matrix.server.id }}
    runs-on: ubuntu-latest
    needs: prepare
    strategy:
      # Deploy to all servers in parallel (set to false for sequential)
      max-parallel: 10
      # Don't cancel other deployments if one fails
      fail-fast: false
      matrix:
        server: ${{ fromJson(needs.prepare.outputs.servers) }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: PRD

      - name: Connect to Tailscale
        uses: tailscale/github-action@v4
        with:
          oauth-client-id: ${{ secrets.TAILSCALE_OAUTH_CLIENT_ID }}
          oauth-secret: ${{ secrets.TAILSCALE_OAUTH_SECRET }}
          tags: tag:github-actions

      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Add server to known hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ matrix.server.host }} -p ${{ matrix.server.port }} >> ~/.ssh/known_hosts

      # === GHCR mode: copy docker-compose.yml to server ===
      - name: Copy docker-compose.yml to server
        if: matrix.server.local_build != true
        run: |
          scp -P ${{ matrix.server.port }} docker-compose.yml \
            ${{ matrix.server.user }}@${{ matrix.server.host }}:${{ matrix.server.deployment_path }}/

      # === GHCR mode: check if deploy needed (image digest comparison) ===
      - name: Check if deployment needed (GHCR)
        if: matrix.server.local_build != true
        id: check-deploy-ghcr
        run: |
          NEEDS_DEPLOY=$(ssh -o LogLevel=ERROR -p ${{ matrix.server.port }} ${{ matrix.server.user }}@${{ matrix.server.host }} << 'ENDSSH' | tail -1
            cd ${{ matrix.server.deployment_path }}

            # Get current running image digest
            CONTAINER_NAME="openclaw_prd_${{ matrix.server.tenant }}_gw"
            CURRENT_DIGEST=$(docker inspect $CONTAINER_NAME --format='{{.Image}}' 2>/dev/null || echo "none")

            # Pull latest image and get its digest
            docker compose pull -q openclaw-gateway 2>&1 >/dev/null || true
            LATEST_DIGEST=$(docker compose images -q openclaw-gateway 2>/dev/null | head -1)

            # Strip sha256: prefix from both for comparison
            CURRENT_SHORT="${CURRENT_DIGEST#sha256:}"
            LATEST_SHORT="${LATEST_DIGEST#sha256:}"

            if [[ -n "$LATEST_SHORT" ]] && [[ "$CURRENT_SHORT" == "$LATEST_SHORT" ]]; then
              echo "‚úÖ Server already running latest image (${LATEST_SHORT:0:12})" >&2
              echo "false"
            else
              echo "üîÑ Update needed: current=${CURRENT_SHORT:0:12}, latest=${LATEST_SHORT:0:12}" >&2
              echo "true"
            fi
          ENDSSH
          )
          echo "needs_deploy=$NEEDS_DEPLOY" >> $GITHUB_OUTPUT
          echo "Deployment needed: $NEEDS_DEPLOY"

      # === Local build mode: check if deploy needed (git SHA comparison) ===
      - name: Check if deployment needed (local build)
        if: matrix.server.local_build == true
        id: check-deploy-local
        run: |
          NEEDS_DEPLOY=$(ssh -o LogLevel=ERROR -p ${{ matrix.server.port }} ${{ matrix.server.user }}@${{ matrix.server.host }} << 'ENDSSH' | tail -1
            cd ${{ matrix.server.deployment_path }}

            git fetch origin PRD 2>/dev/null

            LOCAL_SHA=$(git rev-parse HEAD 2>/dev/null || echo "none")
            REMOTE_SHA=$(git rev-parse origin/PRD 2>/dev/null || echo "unknown")

            if [[ "$LOCAL_SHA" == "$REMOTE_SHA" ]]; then
              echo "‚úÖ Already at latest commit (${LOCAL_SHA:0:12})" >&2
              echo "false"
            else
              echo "üîÑ Update needed: local=${LOCAL_SHA:0:12}, remote=${REMOTE_SHA:0:12}" >&2
              echo "true"
            fi
          ENDSSH
          )
          echo "needs_deploy=$NEEDS_DEPLOY" >> $GITHUB_OUTPUT
          echo "Deployment needed: $NEEDS_DEPLOY"

      # === Resolve needs_deploy from whichever check ran ===
      - name: Resolve deployment decision
        id: check-deploy
        run: |
          if [[ "${{ matrix.server.local_build }}" == "true" ]]; then
            echo "needs_deploy=${{ steps.check-deploy-local.outputs.needs_deploy }}" >> $GITHUB_OUTPUT
          else
            echo "needs_deploy=${{ steps.check-deploy-ghcr.outputs.needs_deploy }}" >> $GITHUB_OUTPUT
          fi

      # === GHCR mode: deploy via image pull ===
      - name: Deploy to ${{ matrix.server.tenant }} (GHCR)
        if: steps.check-deploy.outputs.needs_deploy == 'true' && matrix.server.local_build != true
        run: |
          ssh -p ${{ matrix.server.port }} ${{ matrix.server.user }}@${{ matrix.server.host }} << 'ENDSSH'
            set -e
            cd ${{ matrix.server.deployment_path }}

            echo "=== Deploying to ${{ matrix.server.tenant }} (${{ matrix.server.region }}) via GHCR ==="

            # Tag current running image as rollback
            CONTAINER_NAME="openclaw_prd_${{ matrix.server.tenant }}_gw"
            CURRENT_IMAGE=$(docker inspect $CONTAINER_NAME --format='{{.Image}}' 2>/dev/null || echo "none")
            if [[ "$CURRENT_IMAGE" != "none" ]]; then
              echo "Tagging current image for rollback"
              docker tag $CURRENT_IMAGE ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:prd-rollback-${{ matrix.server.tenant }} || true
            fi

            # Pull new image
            echo "Pulling latest image..."
            docker compose pull openclaw-gateway openclaw-cli

            # Verify pulled image matches host architecture
            PULLED_ARCH=$(docker image inspect $(docker compose images -q openclaw-gateway | head -1) --format='{{.Architecture}}' 2>/dev/null)
            HOST_ARCH=$(uname -m | sed 's/x86_64/amd64/;s/aarch64/arm64/')
            if [[ -n "$PULLED_ARCH" && "$PULLED_ARCH" != "$HOST_ARCH" ]]; then
              echo "FATAL: Pulled image is $PULLED_ARCH but host is $HOST_ARCH"
              exit 1
            fi
            echo "Architecture verified: $PULLED_ARCH matches host $HOST_ARCH"

            # Stop containers gracefully
            echo "Stopping containers..."
            docker compose stop

            # Start with new image
            echo "Starting new containers..."
            docker compose up -d

            # Wait for services to start
            echo "Waiting for services to initialize..."
            sleep 15

            echo "=== Deployment complete for ${{ matrix.server.tenant }} ==="
          ENDSSH

      # === Local build mode: deploy via git pull + docker compose build ===
      - name: Deploy to ${{ matrix.server.tenant }} (local build)
        if: steps.check-deploy.outputs.needs_deploy == 'true' && matrix.server.local_build == true
        run: |
          ssh -p ${{ matrix.server.port }} ${{ matrix.server.user }}@${{ matrix.server.host }} << 'ENDSSH'
            set -e
            cd ${{ matrix.server.deployment_path }}

            echo "=== Deploying to ${{ matrix.server.tenant }} (${{ matrix.server.region }}) via local build ==="

            # Tag current running image as rollback
            ROLLBACK_TAG="openclaw:rollback-${{ matrix.server.tenant }}"
            CONTAINER_NAME="openclaw_prd_${{ matrix.server.tenant }}_gw"
            CURRENT_IMAGE=$(docker inspect $CONTAINER_NAME --format='{{.Image}}' 2>/dev/null || echo "none")
            if [[ "$CURRENT_IMAGE" != "none" ]]; then
              echo "Tagging current image for rollback"
              docker tag $CURRENT_IMAGE $ROLLBACK_TAG || true
            fi

            # Pull latest code
            echo "Pulling latest code from PRD..."
            git fetch origin PRD
            git reset --hard origin/PRD

            # Build image locally
            echo "Building image locally..."
            docker compose build openclaw-gateway

            # Stop containers gracefully
            echo "Stopping containers..."
            docker compose stop

            # Start with new image
            echo "Starting new containers..."
            docker compose up -d

            # Wait for services to start
            echo "Waiting for services to initialize..."
            sleep 15

            echo "=== Deployment complete for ${{ matrix.server.tenant }} ==="
          ENDSSH

      - name: Skip deployment (already up-to-date)
        if: steps.check-deploy.outputs.needs_deploy == 'false'
        run: |
          echo "‚è≠Ô∏è Skipping deployment for ${{ matrix.server.tenant }} - already up-to-date"

      - name: Health check for ${{ matrix.server.tenant }}
        run: |
          ssh -o LogLevel=ERROR -p ${{ matrix.server.port }} ${{ matrix.server.user }}@${{ matrix.server.host }} << 'ENDSSH'
            cd ${{ matrix.server.deployment_path }}

            CONTAINER_NAME="openclaw_prd_${{ matrix.server.tenant }}_gw"

            # Check container status (suppress docker-compose warnings)
            if ! docker compose ps 2>/dev/null | grep -q "$CONTAINER_NAME.*Up"; then
              echo "‚ùå ERROR: Gateway container is not running!"
              exit 1
            fi

            # Test health endpoint
            for i in {1..3}; do
              if docker compose exec -T openclaw-gateway wget -q -O- http://localhost:${{ matrix.server.gateway_port }}/health >/dev/null 2>&1; then
                echo "‚úÖ Health check passed for ${{ matrix.server.tenant }}"
                exit 0
              fi
              echo "Health check attempt $i failed, retrying..."
              sleep 5
            done

            echo "‚ùå Health check failed for ${{ matrix.server.tenant }}"
            exit 1
          ENDSSH

      - name: Cleanup old images on ${{ matrix.server.tenant }}
        if: success()
        run: |
          ssh -o LogLevel=ERROR -p ${{ matrix.server.port }} ${{ matrix.server.user }}@${{ matrix.server.host }} << 'ENDSSH'
            docker image prune -f
            echo "üßπ Old images cleaned up"
          ENDSSH

      - name: Rollback on failure for ${{ matrix.server.tenant }}
        if: failure()
        run: |
          ssh -p ${{ matrix.server.port }} ${{ matrix.server.user }}@${{ matrix.server.host }} << 'ENDSSH'
            cd ${{ matrix.server.deployment_path }}

            echo "=== Rolling back ${{ matrix.server.tenant }} ==="

            if [[ "${{ matrix.server.local_build }}" == "true" ]]; then
              # Local build rollback: use locally tagged rollback image
              ROLLBACK_IMAGE="openclaw:rollback-${{ matrix.server.tenant }}"
            else
              # GHCR rollback: use registry-tagged rollback image
              ROLLBACK_IMAGE="${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:prd-rollback-${{ matrix.server.tenant }}"
            fi

            if docker image inspect "$ROLLBACK_IMAGE" >/dev/null 2>&1; then
              OPENCLAW_IMAGE="$ROLLBACK_IMAGE" docker compose down
              OPENCLAW_IMAGE="$ROLLBACK_IMAGE" docker compose up -d
              echo "=== Rollback complete (using $ROLLBACK_IMAGE) ==="
            else
              echo "=== No rollback image available ‚Äî skipping ==="
            fi
          ENDSSH

  summary:
    name: Deployment Summary
    runs-on: ubuntu-latest
    needs: [prepare, deploy]
    if: always()
    steps:
      - name: Generate deployment report
        run: |
          echo "## üöÄ Multi-Server Deployment Summary"
          echo ""

          TOTAL=$(echo '${{ needs.prepare.outputs.servers }}' | jq 'length')
          echo "üìä **Total servers**: $TOTAL"

          if [[ "${{ needs.deploy.result }}" == "success" ]]; then
            echo "‚úÖ **Status**: All deployments successful"
          else
            echo "‚ö†Ô∏è **Status**: Some deployments failed (check individual job logs)"
          fi

          echo ""
          echo "### Server Details"
          echo '${{ needs.prepare.outputs.servers }}' | jq -r '.[] | "- **\(.tenant)** (\(.region)): \(.host) [mode: \(if .local_build then "local_build" else "ghcr" end)]"'
