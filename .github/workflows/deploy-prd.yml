name: Deploy to Production (Multi-Server)

on:
  push:
    branches:
      - PRD
  workflow_dispatch:

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  prepare:
    name: Load server registry
    runs-on: ubuntu-latest
    outputs:
      servers: ${{ steps.load-servers.outputs.servers }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: PRD

      - name: Load server registry
        id: load-servers
        run: |
          # Load servers from JSON and convert to GitHub Actions matrix format
          SERVERS=$(jq -c '.servers' .github/servers/production.json)
          echo "servers=$SERVERS" >> $GITHUB_OUTPUT

          # Print server count for visibility
          COUNT=$(echo "$SERVERS" | jq 'length')
          echo "üì° Found $COUNT production servers to deploy"

  deploy:
    name: Deploy to ${{ matrix.server.id }}
    runs-on: ubuntu-latest
    needs: prepare
    strategy:
      # Deploy to all servers in parallel (set to false for sequential)
      max-parallel: 10
      # Don't cancel other deployments if one fails
      fail-fast: false
      matrix:
        server: ${{ fromJson(needs.prepare.outputs.servers) }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: PRD

      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Add server to known hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ matrix.server.host }} -p ${{ matrix.server.port }} >> ~/.ssh/known_hosts

      - name: Copy docker-compose.yml to server
        run: |
          scp -P ${{ matrix.server.port }} docker-compose.yml \
            ${{ matrix.server.user }}@${{ matrix.server.host }}:${{ matrix.server.deployment_path }}/

      - name: Deploy to ${{ matrix.server.tenant }}
        run: |
          ssh -p ${{ matrix.server.port }} ${{ matrix.server.user }}@${{ matrix.server.host }} << 'ENDSSH'
            set -e
            cd ${{ matrix.server.deployment_path }}

            echo "=== Deploying to ${{ matrix.server.tenant }} (${{ matrix.server.region }}) ==="

            # Tag current running image as rollback
            CONTAINER_NAME="${{ matrix.server.container_prefix }}_openclaw_gw"
            CURRENT_IMAGE=$(docker inspect $CONTAINER_NAME --format='{{.Image}}' 2>/dev/null || echo "none")
            if [[ "$CURRENT_IMAGE" != "none" ]]; then
              echo "Tagging current image for rollback"
              docker tag $CURRENT_IMAGE ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:prd-rollback-${{ matrix.server.container_prefix }} || true
            fi

            # Pull new image
            echo "Pulling latest image..."
            docker compose pull openclaw-gateway openclaw-cli

            # Stop containers gracefully
            echo "Stopping containers..."
            docker compose stop

            # Start with new image
            echo "Starting new containers..."
            docker compose up -d

            # Wait for services to start
            echo "Waiting for services to initialize..."
            sleep 15

            echo "=== Deployment complete for ${{ matrix.server.tenant }} ==="
          ENDSSH

      - name: Health check for ${{ matrix.server.tenant }}
        run: |
          ssh -p ${{ matrix.server.port }} ${{ matrix.server.user }}@${{ matrix.server.host }} << 'ENDSSH'
            set -e
            cd ${{ matrix.server.deployment_path }}

            CONTAINER_NAME="${{ matrix.server.container_prefix }}_openclaw_gw"

            # Check container status
            if ! docker compose ps | grep -q "$CONTAINER_NAME.*Up"; then
              echo "‚ùå ERROR: Gateway container is not running!"
              exit 1
            fi

            # Test health endpoint
            for i in {1..3}; do
              if docker compose exec -T openclaw-gateway wget -q -O- http://localhost:${{ matrix.server.gateway_port }}/health >/dev/null 2>&1; then
                echo "‚úÖ Health check passed for ${{ matrix.server.tenant }}"
                exit 0
              fi
              echo "Health check attempt $i failed, retrying..."
              sleep 5
            done

            echo "‚ùå Health check failed for ${{ matrix.server.tenant }}"
            exit 1
          ENDSSH

      - name: Rollback on failure for ${{ matrix.server.tenant }}
        if: failure()
        run: |
          ssh -p ${{ matrix.server.port }} ${{ matrix.server.user }}@${{ matrix.server.host }} << 'ENDSSH'
            cd ${{ matrix.server.deployment_path }}

            echo "=== Rolling back ${{ matrix.server.tenant }} ==="

            # Update .env to use rollback tag
            sed -i 's/:prd/:prd-rollback-${{ matrix.server.container_prefix }}/g' .env

            docker compose down
            docker compose up -d

            # Restore .env
            sed -i 's/:prd-rollback-${{ matrix.server.container_prefix }}/:prd/g' .env

            echo "=== Rollback complete ==="
          ENDSSH

  summary:
    name: Deployment Summary
    runs-on: ubuntu-latest
    needs: [prepare, deploy]
    if: always()
    steps:
      - name: Generate deployment report
        run: |
          echo "## üöÄ Multi-Server Deployment Summary"
          echo ""

          TOTAL=$(echo '${{ needs.prepare.outputs.servers }}' | jq 'length')
          echo "üìä **Total servers**: $TOTAL"

          if [[ "${{ needs.deploy.result }}" == "success" ]]; then
            echo "‚úÖ **Status**: All deployments successful"
          else
            echo "‚ö†Ô∏è **Status**: Some deployments failed (check individual job logs)"
          fi

          echo ""
          echo "### Server Details"
          echo '${{ needs.prepare.outputs.servers }}' | jq -r '.[] | "- **\(.tenant)** (\(.region)): \(.host)"'
