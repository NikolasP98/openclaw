# Automatic Multi-Tenant Production Deployment Setup Guide

This guide walks you through setting up automatic deployment for OpenClaw to production servers.

## Overview

The automatic deployment system:
- ✅ Triggers when PRD branch is updated
- ✅ Builds and pushes Docker images to GHCR
- ✅ Deploys to production servers automatically
- ✅ Includes health checks and automatic rollback
- ✅ Supports single or multi-server deployments
- ✅ Zero-downtime deployments
- ✅ Multi-tenant architecture ready

## Quick Start

### Phase 1: Single Server Deployment

Use this for your first production server.

#### 1. Run the Setup Script

From your local machine:

```bash
cd scripts/deployment
./setup-server.sh 100.105.147.99 22
```

This script will:
- Create a `deploy` user on the server
- Generate SSH keys
- Set up directory structure
- Create production `.env` template
- Generate secure gateway token
- Copy `docker-compose.yml`

#### 2. Configure Production Environment

SSH to the server and edit the `.env` file:

```bash
ssh -i ~/.ssh/openclaw/openclaw_deploy_key deploy@100.105.147.99
nano ~/openclaw-prd/.env
```

Update these values:
- `CLAUDE_AI_SESSION_KEY`: Your Claude API session key
- `CLAUDE_WEB_SESSION_KEY`: Your Claude web session key
- `CLAUDE_WEB_COOKIE`: Your Claude web cookie

The `OPENCLAW_GATEWAY_TOKEN` has already been generated by the setup script.

#### 3. Test Manual Deployment

Still on the server:

```bash
cd ~/openclaw-prd
docker compose pull
docker compose up -d
docker compose ps
docker compose logs -f openclaw-gateway
```

Verify the gateway is running:
```bash
curl http://localhost:18789/health
```

#### 4. Add GitHub Secrets

Go to your GitHub repository: **Settings → Secrets and variables → Actions → New repository secret**

Add these 5 secrets:

| Secret Name | Value | Where to Find |
|-------------|-------|---------------|
| `SSH_PRIVATE_KEY` | Contents of `~/.ssh/openclaw/openclaw_deploy_key` | `cat ~/.ssh/openclaw/openclaw_deploy_key` |
| `SSH_HOST` | `100.105.147.99` | Your server IP |
| `SSH_USER` | `deploy` | Always "deploy" |
| `SSH_PORT` | `22` | SSH port (default 22) |
| `DEPLOYMENT_PATH` | `/home/deploy/openclaw-prd` | Deployment directory |

**Important**: Copy the ENTIRE private key including the `-----BEGIN` and `-----END` lines.

#### 5. Test Automatic Deployment

```bash
git checkout PRD
git commit --allow-empty -m "test: trigger automatic deployment"
git push origin PRD
```

Watch the deployment:
1. Go to GitHub → Actions tab
2. "Docker Release" workflow builds the image
3. "Deploy to Production" workflow deploys to server
4. Check logs for any errors

Verify on server:
```bash
ssh -i ~/.ssh/openclaw/openclaw_deploy_key deploy@100.105.147.99
docker ps | grep openclaw
docker compose logs --tail=50 openclaw-gateway
```

✅ **Phase 1 Complete!** Your server now deploys automatically when PRD branch is updated.

---

### Phase 2: Multi-Server Deployment

Use this when you need to deploy to multiple servers (2-20 servers).

#### 1. Setup Additional Servers

Run the setup script for each new server:

```bash
./setup-server.sh 100.105.148.100 22  # Server 2
./setup-server.sh 100.105.149.101 22  # Server 3
```

**Note**: The same SSH key (`~/.ssh/openclaw/openclaw_deploy_key`) is used for all servers.

#### 2. Update Server Registry

Edit `.github/servers/production.json` and add your servers:

```json
{
  "servers": [
    {
      "id": "prd-tenant-acme",
      "host": "100.105.147.99",
      "user": "deploy",
      "port": 22,
      "deployment_path": "/home/deploy/openclaw-prd-acme",
      "container_prefix": "acme",
      "gateway_port": 18789,
      "bridge_port": 18790,
      "tenant": "acme-corp",
      "region": "us-east"
    },
    {
      "id": "prd-tenant-widgets",
      "host": "100.105.148.100",
      "user": "deploy",
      "port": 22,
      "deployment_path": "/home/deploy/openclaw-prd-widgets",
      "container_prefix": "widgets",
      "gateway_port": 18789,
      "bridge_port": 18790,
      "tenant": "widgets-inc",
      "region": "eu-west"
    }
  ]
}
```

#### 3. Configure Per-Tenant Environments

On each server, create a tenant-specific `.env` file:

**Server 1 (ACME)**: `/home/deploy/openclaw-prd-acme/.env`
```bash
OPENCLAW_GATEWAY_CONTAINER_NAME=acme_openclaw_gw
OPENCLAW_CLI_CONTAINER_NAME=acme_openclaw_cli
OPENCLAW_CONFIG_DIR=/home/deploy/.openclaw-prd-acme
OPENCLAW_WORKSPACE_DIR=/home/deploy/.openclaw-prd-acme/workspace
# ... tenant-specific credentials
```

**Server 2 (Widgets)**: `/home/deploy/openclaw-prd-widgets/.env`
```bash
OPENCLAW_GATEWAY_CONTAINER_NAME=widgets_openclaw_gw
OPENCLAW_CLI_CONTAINER_NAME=widgets_openclaw_cli
OPENCLAW_CONFIG_DIR=/home/deploy/.openclaw-prd-widgets
OPENCLAW_WORKSPACE_DIR=/home/deploy/.openclaw-prd-widgets/workspace
# ... tenant-specific credentials
```

#### 4. Switch to Multi-Server Workflow

Rename the workflows:

```bash
# Disable single-server workflow
mv .github/workflows/deploy-prd.yml .github/workflows/deploy-prd.yml.disabled

# Enable multi-server workflow
mv .github/workflows/deploy-prd-multi.yml.disabled .github/workflows/deploy-prd-multi.yml
```

Or simply delete `deploy-prd.yml` and rename `deploy-prd-multi.yml` to `deploy-prd.yml`.

#### 5. Test Multi-Server Deployment

```bash
git add .github/servers/production.json
git commit -m "feat: add multi-server deployment"
git push origin PRD
```

Watch the deployment in GitHub Actions. You should see:
- Multiple deployment jobs running in parallel
- Independent health checks for each server
- Deployment summary showing all servers

✅ **Phase 2 Complete!** You can now deploy to multiple servers in parallel.

---

## Adding New Tenants

1. **Provision server** (or use existing):
   ```bash
   ./setup-server.sh <new-server-ip> 22
   ```

2. **Add to server registry**:
   ```json
   {
     "id": "prd-tenant-newtenant",
     "host": "<new-server-ip>",
     "user": "deploy",
     "port": 22,
     "deployment_path": "/home/deploy/openclaw-prd-newtenant",
     "container_prefix": "newtenant",
     "gateway_port": 18789,
     "bridge_port": 18790,
     "tenant": "newtenant-corp",
     "region": "us-central"
   }
   ```

3. **Configure `.env`** on the server

4. **Commit and push**:
   ```bash
   git add .github/servers/production.json
   git commit -m "feat: add tenant newtenant-corp"
   git push origin PRD
   ```

The deployment happens automatically!

---

## Removing Tenants

1. **Remove from server registry**:
   Edit `.github/servers/production.json` and delete the tenant entry

2. **Commit and push**:
   ```bash
   git add .github/servers/production.json
   git commit -m "feat: remove tenant oldtenant-corp"
   git push origin PRD
   ```

3. **Manually stop containers**:
   ```bash
   ssh deploy@<server-ip>
   cd ~/openclaw-prd-oldtenant
   docker compose down
   ```

4. **Optional cleanup**:
   ```bash
   rm -rf ~/openclaw-prd-oldtenant
   rm -rf ~/.openclaw-prd-oldtenant
   docker system prune -a
   ```

---

## Monitoring and Maintenance

### Daily

- Monitor GitHub Actions for deployment failures
- Check server health: `curl http://<server-ip>:18789/health`

### Weekly

- Review container logs: `docker compose logs | grep -i error`
- Check disk usage: `docker system df`

### Monthly

- Prune unused images: `docker system prune -a --volumes`
- Rotate `OPENCLAW_GATEWAY_TOKEN`
- Review SSH access logs

### Quarterly

- Rotate SSH deployment keys
- Update GitHub Secrets
- Review and update `.env` configuration

---

## Backup and Recovery

### Setting Up Automatic Backups

Copy the backup script to each server:

```bash
scp scripts/deployment/backup-openclaw.sh deploy@<server-ip>:~/
ssh deploy@<server-ip>
chmod +x ~/backup-openclaw.sh
```

Add to crontab (runs daily at 2 AM):

```bash
crontab -e
# Add this line:
0 2 * * * /home/deploy/backup-openclaw.sh
```

### Manual Backup

```bash
ssh deploy@<server-ip>
cd ~
tar -czf openclaw-backup-$(date +%Y%m%d).tar.gz .openclaw-prd openclaw-prd
```

### Restore from Backup

```bash
ssh deploy@<server-ip>
cd ~/openclaw-prd
docker compose down
cd ~
tar -xzf openclaw-backup-<date>.tar.gz
cd ~/openclaw-prd
docker compose up -d
```

---

## Troubleshooting

### Deployment fails with "SSH connection failed"

1. Verify SSH key is added to GitHub Secrets
2. Test SSH connection manually:
   ```bash
   ssh -i ~/.ssh/openclaw/openclaw_deploy_key deploy@<server-ip>
   ```
3. Check server firewall allows SSH (port 22)

### Health check fails

1. SSH to server and check container status:
   ```bash
   docker compose ps
   docker compose logs openclaw-gateway
   ```
2. Test health endpoint:
   ```bash
   curl http://localhost:18789/health
   ```
3. Check if `.env` credentials are correct

### Containers won't start

1. Check Docker service:
   ```bash
   sudo systemctl status docker
   ```
2. Check disk space:
   ```bash
   df -h
   ```
3. Check logs:
   ```bash
   journalctl -u docker -f
   ```

### Manual Rollback

If automatic rollback fails:

```bash
ssh deploy@<server-ip>
cd ~/openclaw-prd
sed -i 's/:prd/:prd-rollback/g' .env
docker compose down
docker compose up -d
# After verifying rollback worked:
sed -i 's/:prd-rollback/:prd/g' .env
```

---

## Security Hardening (Optional)

### Disable Password Authentication

On the server as root:

```bash
cat >> /etc/ssh/sshd_config <<EOF

# Deploy user hardening
Match User deploy
    PasswordAuthentication no
    PubkeyAuthentication yes
